<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>示例：在模块中实现图像二值化 | GtHawkeye视觉平台</title>
    <meta name="description" content="Welcome">
    
    
    <link rel="preload" href="/assets/css/0.styles.177b5ee6.css" as="style"><link rel="preload" href="/assets/js/app.e904eec8.js" as="script"><link rel="preload" href="/assets/js/13.c5e4b4e0.js" as="script"><link rel="prefetch" href="/assets/js/10.cdff6104.js"><link rel="prefetch" href="/assets/js/11.6d4e6612.js"><link rel="prefetch" href="/assets/js/12.24597b9c.js"><link rel="prefetch" href="/assets/js/14.dd52ec26.js"><link rel="prefetch" href="/assets/js/15.d6de0f45.js"><link rel="prefetch" href="/assets/js/16.16066f5a.js"><link rel="prefetch" href="/assets/js/17.ff624283.js"><link rel="prefetch" href="/assets/js/18.5310fd53.js"><link rel="prefetch" href="/assets/js/19.76ed3803.js"><link rel="prefetch" href="/assets/js/2.91fbb1e9.js"><link rel="prefetch" href="/assets/js/3.f4cdf44e.js"><link rel="prefetch" href="/assets/js/4.7209c065.js"><link rel="prefetch" href="/assets/js/5.1eae4793.js"><link rel="prefetch" href="/assets/js/6.0a2e8849.js"><link rel="prefetch" href="/assets/js/7.98b78ba0.js"><link rel="prefetch" href="/assets/js/8.a1c7d56c.js"><link rel="prefetch" href="/assets/js/9.34fafb42.js">
    <link rel="stylesheet" href="/assets/css/0.styles.177b5ee6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">GtHawkeye视觉平台</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/handbook/handbook2-quickuse.html" class="nav-link">使用软件</a></div><div class="nav-item"><a href="/module_program/module1-env.html" class="nav-link">开发算法模块</a></div><div class="nav-item"><a href="/ui_program/ui_program_intro.html" class="nav-link">自定义视觉界面</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/handbook/handbook2-quickuse.html" class="nav-link">使用软件</a></div><div class="nav-item"><a href="/module_program/module1-env.html" class="nav-link">开发算法模块</a></div><div class="nav-item"><a href="/ui_program/ui_program_intro.html" class="nav-link">自定义视觉界面</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>开发算法模块</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/module_program/module1-env.html" class="sidebar-link">基本介绍</a></li><li><a href="/module_program/module2-algoth.html" class="sidebar-link">算法dll开发</a></li><li><a href="/module_program/module3-ui.html" class="sidebar-link">界面dll开发</a></li><li><a href="/module_program/module4-example.html" class="active sidebar-link">示例：在模块中实现图像二值化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/module_program/module4-example.html#依赖文件包" class="sidebar-link">依赖文件包</a></li><li class="sidebar-sub-header"><a href="/module_program/module4-example.html#声明所需成员变量和成员函数" class="sidebar-link">声明所需成员变量和成员函数</a></li><li class="sidebar-sub-header"><a href="/module_program/module4-example.html#在算法模块中实现二值化功能" class="sidebar-link">在算法模块中实现二值化功能</a></li><li class="sidebar-sub-header"><a href="/module_program/module4-example.html#在界面模块中实现调整算法模块的参数" class="sidebar-link">在界面模块中实现调整算法模块的参数</a></li><li class="sidebar-sub-header"><a href="/module_program/module4-example.html#注册算法类和界面类" class="sidebar-link">注册算法类和界面类</a></li></ul></li><li><a href="/module_program/module_update_log.html" class="sidebar-link">更新日志</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="示例：在模块中实现图像二值化"><a href="#示例：在模块中实现图像二值化" aria-hidden="true" class="header-anchor">#</a> 示例：在模块中实现图像二值化</h1> <p>最终效果如下所示</p> <p><img src="https://coding.net/api/project/2904101/files/4617525/imagePreview" alt="图片"></p> <h2 id="依赖文件包"><a href="#依赖文件包" aria-hidden="true" class="header-anchor">#</a> 依赖文件包</h2> <p>本示例中使用OpenCV4.0.0作为二值化工具。若使用本软件配套的开发Demo工程，则无需额外配置；若是新建的工程，请自行按照OpenCV官方文档进行工程配置。</p> <h2 id="声明所需成员变量和成员函数"><a href="#声明所需成员变量和成员函数" aria-hidden="true" class="header-anchor">#</a> 声明所需成员变量和成员函数</h2> <p>在算法类<code>ModuleDemo</code>中的module_demo.h头文件中添加从基类继承的函数以及为了实现二值化所需要的函数和成员变量</p> <div class="language-c extra-class"><pre class="language-c"><code>public<span class="token punctuation">:</span>
	<span class="token function">ModuleDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//必须提供一个析构函数供主程序调用</span>
	<span class="token operator">~</span><span class="token function">ModuleDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//从基类继承的纯虚函数，请参考基类头文件 abstract_module.h </span>
	<span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">initResultsType</span><span class="token punctuation">(</span>MyResult <span class="token operator">*</span>result<span class="token punctuation">,</span> DrawableResult <span class="token operator">*</span>draw_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">prepareParam</span><span class="token punctuation">(</span><span class="token keyword">int</span> runtime_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">const</span> GtMat <span class="token operator">*</span>mat<span class="token punctuation">,</span> MyResult <span class="token operator">*</span>result<span class="token punctuation">,</span> DrawableResult <span class="token operator">*</span>draw_result<span class="token punctuation">,</span> <span class="token keyword">int</span> runtime_mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">output</span><span class="token punctuation">(</span>MyResult <span class="token operator">*</span>result<span class="token punctuation">,</span> DrawableResult <span class="token operator">*</span>draw_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">saveParam</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString <span class="token operator">&amp;</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> QString <span class="token operator">&amp;</span>module_id<span class="token punctuation">,</span> QJsonObject <span class="token operator">&amp;</span>json<span class="token punctuation">,</span> bool param_only<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">readParam</span><span class="token punctuation">(</span><span class="token keyword">const</span> QJsonObject <span class="token operator">&amp;</span>json<span class="token punctuation">,</span> <span class="token keyword">const</span> QString <span class="token operator">&amp;</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> QString <span class="token operator">&amp;</span>module_id<span class="token punctuation">,</span> bool param_only<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//二值化的实现函数</span>
	<span class="token keyword">void</span> <span class="token function">doBinary</span><span class="token punctuation">(</span>cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Rect rect<span class="token punctuation">,</span> cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Mat mat<span class="token punctuation">)</span><span class="token punctuation">;</span>

private<span class="token punctuation">:</span>
	<span class="token keyword">float</span> binary_threshold_<span class="token punctuation">;</span>		         <span class="token comment">//二值化阈值</span>
	cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Rect roi_rect_<span class="token punctuation">;</span>				<span class="token comment">//roi区域</span>
	cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Mat input_mat_<span class="token punctuation">;</span>				<span class="token comment">//运行时的输入</span>
	cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Mat refer_mat_<span class="token punctuation">;</span>				<span class="token comment">//配置参数时的基准图像</span>
	cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Mat binary_mat_<span class="token punctuation">;</span>			<span class="token comment">//二值化之后的图像</span>
</code></pre></div><p>在界面类<code>UIDemo</code>中的ui_demo.h头文件中添加所需成员函数和变量</p> <div class="language-c extra-class"><pre class="language-c"><code>public<span class="token punctuation">:</span>
	<span class="token comment">//继承自AbstractModuleWidget纯虚函数</span>
	QWidget <span class="token operator">*</span> <span class="token function">getConfigWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//创建用户自己编辑的widget</span>
	<span class="token keyword">void</span> <span class="token function">releaseConfigWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//删除widget</span>
	<span class="token keyword">void</span> <span class="token function">saveParamsToModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//保存参数到算法模块</span>
	bool <span class="token function">setAbstractModulePtr</span><span class="token punctuation">(</span>AbstractModule <span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获得算法模块的指针，用于调用算法模块的函数</span>
	<span class="token keyword">void</span> <span class="token function">initParamUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//继承自AbstractModuleWidget的虚函数，根据用户需求选择实现</span>
	<span class="token keyword">void</span> <span class="token function">initDisplay</span><span class="token punctuation">(</span>GtDisplay <span class="token operator">*</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//拿到GtDisplay指针，用于调用GtDisplay的函数</span>
	<span class="token keyword">void</span> <span class="token function">doAfterReferImageChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//当基准图像被改变时，该函数被调用</span>
	

private<span class="token punctuation">:</span>
	WidgetDemo <span class="token operator">*</span> widget_ <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>  <span class="token comment">//用户编辑的界面窗口指针</span>
</code></pre></div><p>这里需要说明的是，这个<code>UIDemo</code>类是本平台提供的<code>AbstractModuleWidget</code>基类的子类，而不是qt的窗口类。<code>WidgetDemo</code>这个类才是用户自己创建的Qt <code>QWidget</code>类，用户在这个类中编辑自己的窗口界面。<code>UIDemo</code>类通过成员变量<code>widget_</code>从<code>WidgetDemo</code>中获得参数，通过继承的接口实现平台所需功能（如保存、传递参数）；或者通过该指针根据保存的参数修改界面中的对象。</p> <p>在<code>WidgetDemo</code>类的头文件中添加所需的函数和变量</p> <div class="language-c extra-class"><pre class="language-c"><code>public<span class="token punctuation">:</span>
	<span class="token function">WidgetDemo</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent <span class="token operator">=</span> Q_NULLPTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">WidgetDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//获得算法模块对象，通过该指针将界面配置的参数传递至算法模块</span>
	bool <span class="token function">setMdlPtr</span><span class="token punctuation">(</span>AbstractModule <span class="token operator">*</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获得基准图像窗口，通过该指针对窗口进行操作</span>
	bool <span class="token function">initDisplay</span><span class="token punctuation">(</span>GtDisplay <span class="token operator">*</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将界面获得的参数保存到算法模块，在关闭配置界面并保存时被调用</span>
	<span class="token keyword">void</span> <span class="token function">saveParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//当基准图像变化时被调用</span>
	<span class="token keyword">void</span> <span class="token function">doAfterReferImageChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//初始化窗口界面</span>
	<span class="token keyword">void</span> <span class="token function">initParamUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

public slots<span class="token punctuation">:</span>
	<span class="token comment">//设置二值化阈值</span>
	<span class="token keyword">void</span> <span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//接收roi的位置和大小数据</span>
	<span class="token keyword">void</span> <span class="token function">slotUpdateItemData</span><span class="token punctuation">(</span>bool valid<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve0<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve1<span class="token punctuation">,</span>
		<span class="token keyword">double</span> reserve2<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve3<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve4<span class="token punctuation">,</span> QString <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

private<span class="token punctuation">:</span>
	Ui<span class="token punctuation">:</span><span class="token punctuation">:</span>UIDemo ui<span class="token punctuation">;</span>

	GtDisplay <span class="token operator">*</span>display_<span class="token punctuation">;</span>					<span class="token comment">//图像显示窗口的指针</span>
	ModuleDemo <span class="token operator">*</span>mdl_<span class="token punctuation">;</span>						<span class="token comment">//算法模块指针</span>

	QGraphicsPixmapItem<span class="token operator">*</span> roi_overlay_<span class="token punctuation">;</span>		<span class="token comment">//覆盖roi区域的qt对象</span>

	<span class="token keyword">void</span> <span class="token function">initConnects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//构造信号槽</span>
	<span class="token keyword">void</span> <span class="token function">updateROI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//更新roi区域</span>
</code></pre></div><p>public的成员函数多数与ui类对应，因此ui类中这些函数的实现只需调用widget类中对应的函数即可。</p> <h2 id="在算法模块中实现二值化功能"><a href="#在算法模块中实现二值化功能" aria-hidden="true" class="header-anchor">#</a> 在算法模块中实现二值化功能</h2> <h4 id="_1-构造函数"><a href="#_1-构造函数" aria-hidden="true" class="header-anchor">#</a> 1. 构造函数</h4> <div class="language-c extra-class"><pre class="language-c"><code>using namespace cv<span class="token punctuation">;</span>
using namespace std<span class="token punctuation">;</span>

ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ModuleDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token function">roi_rect_</span><span class="token punctuation">(</span><span class="token function">Rect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">//初始化roi大小和位置</span>
	<span class="token function">binary_threshold_</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>                            <span class="token comment">//初始化二值化阈值</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-释放函数"><a href="#_2-释放函数" aria-hidden="true" class="header-anchor">#</a> 2. 释放函数</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	delete this<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-初始化输出结果"><a href="#_3-初始化输出结果" aria-hidden="true" class="header-anchor">#</a> 3. 初始化输出结果</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">initResultsType</span><span class="token punctuation">(</span>MyResult <span class="token operator">*</span> result<span class="token punctuation">,</span> DrawableResult <span class="token operator">*</span> draw_result<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token comment">//声明添加单一文本结果x坐标和y坐标，会显示在结果表格中	</span>
        result<span class="token operator">-&gt;</span><span class="token function">addSingleResult</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> BASIC_INT<span class="token punctuation">)</span><span class="token punctuation">;</span>						
	result<span class="token operator">-&gt;</span><span class="token function">addSingleResult</span><span class="token punctuation">(</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">,</span> BASIC_INT<span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token comment">//声明绘制结果中总共有1中绘制类型</span>
	draw_result<span class="token operator">-&gt;</span><span class="token function">setTypeNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
        <span class="token comment">//声明第0个绘制类型的为ROTATE_RECT类型，该类型的结果最多有1个</span>
	draw_result<span class="token operator">-&gt;</span><span class="token function">setElementType</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DrawElement<span class="token punctuation">:</span><span class="token punctuation">:</span>ROTATE_RECT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre></div><p>我们的目标是在文本输出表格中显示roi框的左上角顶点坐标，以及在主界面右侧显示图像的区域画出roi框。所以我们首先对<code>MyResult</code>类的对象指针<code>result</code>调用<code>addSingleResult()</code>。传入的参数为数据名称和数据类型。接下来声明绘制结果，对<code>DrawableResult</code>类的对象指针<code>draw_result</code>调用<code>setTypeNumber()</code>设置绘制结果类型的个数，这个个数会为<code>draw_result</code>的<code>elements</code>指针申请内存，用于存放我们的绘制结果中所有绘制元素的种类。调用<code>setElementType()</code>设置绘制类型和该类型的最大绘制数。</p> <h4 id="_4-参数检查函数"><a href="#_4-参数检查函数" aria-hidden="true" class="header-anchor">#</a> 4. 参数检查函数</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">prepareParam</span><span class="token punctuation">(</span><span class="token keyword">int</span> runtime_mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为本模块运行时需要的参数都会被初始化，不会出现参数为空的情况，即使不经过UI页面配置也可以运行，所以在这里我们不检查参数。
需要说明的是，虽然运行时所需参数都会被初始化，但我们不能保证初始化的参数都是合法的，比如说，我们初始化的<code>roi_rect_</code>左上角定点位于(100, 100)，长宽分别为150和100。如果运行时的输入图像足够小导致它超出了图像区域，那么该参数就是不合法的，但这无法在<code>prepareParam(int runtime_mode)</code>这个函数中做检测，因为我们无法得知运行时的输入图片是怎样的。因此，我们应该在运行时也设置必要的参数检测保证自己的模块不会崩溃。</p> <h4 id="_5-运行时函数"><a href="#_5-运行时函数" aria-hidden="true" class="header-anchor">#</a> 5. 运行时函数</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">const</span> GtMat <span class="token operator">*</span> mat<span class="token punctuation">,</span> MyResult <span class="token operator">*</span> result<span class="token punctuation">,</span> DrawableResult <span class="token operator">*</span> draw_result<span class="token punctuation">,</span> <span class="token keyword">int</span> runtime_mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//检查输入是否为空</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mat <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">1010</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将输入数据从GtMat格式转换为OpenCV的Mat格式</span>
	input_mat_ <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span>mat<span class="token operator">-&gt;</span>rows<span class="token punctuation">,</span> mat<span class="token operator">-&gt;</span>cols<span class="token punctuation">,</span> CV_8UC1<span class="token punctuation">,</span> mat<span class="token operator">-&gt;</span>image_data<span class="token punctuation">,</span> mat<span class="token operator">-&gt;</span>cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将选定区域二值化</span>
	<span class="token function">doBinary</span><span class="token punctuation">(</span>roi_rect_<span class="token punctuation">,</span> input_mat_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//返回0表示该轮运行成功</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GtMat</code>是本平台通用的图像数据结构，用户可以将该数据结构转化为自己需要的形式。在本例中，我们将它转化为OpenCV的Mat格式。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">doBinary</span><span class="token punctuation">(</span>Rect rect<span class="token punctuation">,</span> Mat mat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//检查roi区域是否在输入图像范围内</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
	    rect<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
	    rect<span class="token punctuation">.</span>x <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> mat<span class="token punctuation">.</span>rows <span class="token operator">||</span>
	    rect<span class="token punctuation">.</span>y <span class="token operator">+</span> rect<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> mat<span class="token punctuation">.</span>cols<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	Mat temp <span class="token operator">=</span> <span class="token function">mat</span><span class="token punctuation">(</span>roi_rect_<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//二值化</span>
	<span class="token function">threshold</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> binary_mat_<span class="token punctuation">,</span> <span class="token number">255</span> <span class="token operator">*</span> binary_threshold_<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> THRESH_BINARY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>doBinary(Rect rect, Mat mat)</code>首先检测输入的合法性，当roi区域超出图像的范围时，我们粗暴地<code>return</code>。如果合法，那么我们就将该区域二值化，并保存在<code>binary_mat_</code>这个成员变量中。</p> <h4 id="_6-输出函数"><a href="#_6-输出函数" aria-hidden="true" class="header-anchor">#</a> 6. 输出函数</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">output</span><span class="token punctuation">(</span>MyResult <span class="token operator">*</span> result<span class="token punctuation">,</span> DrawableResult <span class="token operator">*</span> draw_result<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//设置文本输出</span>
	result<span class="token operator">-&gt;</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> roi_rect_<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	result<span class="token operator">-&gt;</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">,</span> roi_rect_<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//设置绘制输出</span>
	draw_result<span class="token operator">-&gt;</span>elements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>element_number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	DrawElement<span class="token punctuation">:</span><span class="token punctuation">:</span>RotateRectDrawable<span class="token operator">*</span> rect <span class="token operator">=</span> <span class="token punctuation">(</span>DrawElement<span class="token punctuation">:</span><span class="token punctuation">:</span>RotateRectDrawable<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>draw_result<span class="token operator">-&gt;</span>elements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	rect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cx <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>x <span class="token operator">+</span> roi_rect_<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
	rect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cy <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>y <span class="token operator">+</span> roi_rect_<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
	rect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>width <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
	rect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>height <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
	rect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>angle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>文本输出设置很好理解，在此不做过多解释。
<code>DrawableResult</code>这个结构体拥有一个<code>elements</code>指针，用来保存绘制输出中所有绘制元素。在初始化输出结果函数<code>initResultsType(MyResult * result, DrawableResult * draw_result)</code>中，我们设置了绘制元素种类的个数为1，并指定它为<code>ROTATE_RECT</code>。因此，这里的<code>elements</code>指针只含有1个元素，它为<code>ROTATE_RECT</code>。我们在声明的时候设置该种类可以绘制的最大个数为1，在这里我们用<code>element_number</code>设置实际绘制的个数。接下来，我们从<code>draw_result</code>中拿到该种类的数据指针，将其强制转换成它的子类<code>RotateRectDrawable</code>，并将位置信息写入其中。至此，绘制结果设置完毕。</p> <h4 id="_7-保存与读取工程"><a href="#_7-保存与读取工程" aria-hidden="true" class="header-anchor">#</a> 7. 保存与读取工程</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">saveParam</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString <span class="token operator">&amp;</span> path<span class="token punctuation">,</span> <span class="token keyword">const</span> QString <span class="token operator">&amp;</span> module_id<span class="token punctuation">,</span> QJsonObject <span class="token operator">&amp;</span> json<span class="token punctuation">,</span> bool param_only<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	json<span class="token punctuation">[</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	json<span class="token punctuation">[</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
	json<span class="token punctuation">[</span><span class="token string">&quot;width&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
	json<span class="token punctuation">[</span><span class="token string">&quot;height&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> roi_rect_<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
	json<span class="token punctuation">[</span><span class="token string">&quot;threshold&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> binary_threshold_<span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">readParam</span><span class="token punctuation">(</span><span class="token keyword">const</span> QJsonObject <span class="token operator">&amp;</span> json<span class="token punctuation">,</span> <span class="token keyword">const</span> QString <span class="token operator">&amp;</span> path<span class="token punctuation">,</span> <span class="token keyword">const</span> QString <span class="token operator">&amp;</span> module_id<span class="token punctuation">,</span> bool param_only<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	roi_rect_<span class="token punctuation">.</span>x <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	roi_rect_<span class="token punctuation">.</span>y <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	roi_rect_<span class="token punctuation">.</span>width <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">&quot;width&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	roi_rect_<span class="token punctuation">.</span>height <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">&quot;height&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	binary_threshold_ <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">&quot;threshold&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们需要保存的参数是<code>roi_rect_</code>和<code>binary_threshold_</code>。本平台统一采用json的格式保存和读取数据，同时提供保存和读取的路径，方便有需求的用户保存文件。<code>module_id</code>为平台框架为每个模块分发的编号，提供给用户在给保存的文件起名时使用，防止多个相同的模块使用相同的文件名。布尔型参数<code>param_only</code>在点击主页面的保存和打开工程时传入的值为<code>false</code>；当用户对界面进行二次开发时调用<code>WorkflowList</code>类中的<code>getMdlParam()</code>来读取工程文件的参数和调用<code>setMdlParam()</code>来修改工程文件时，传入的参数为<code>false</code>。</p> <h4 id="_8-读取基准图像"><a href="#_8-读取基准图像" aria-hidden="true" class="header-anchor">#</a> 8. 读取基准图像</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> ModuleDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setReferImage</span><span class="token punctuation">(</span><span class="token keyword">const</span> GtMat <span class="token operator">*</span> image<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>image <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		refer_mat_ <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		refer_mat_ <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span>image<span class="token operator">-&gt;</span>rows<span class="token punctuation">,</span> image<span class="token operator">-&gt;</span>cols<span class="token punctuation">,</span> CV_8UC1<span class="token punctuation">,</span> image<span class="token operator">-&gt;</span>image_data<span class="token punctuation">,</span> image<span class="token operator">-&gt;</span>cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>与读取运行时的输入图像类似，基准图像也是以<code>GtMat</code>的数据结构传入。在本例中，我们将它以<code>Mat</code>的格式保存在<code>refer_mat_</code>成员变量中。<code>setReferImage()</code>函数会在基准图像改变时和读取工程时被调用。</p> <h2 id="在界面模块中实现调整算法模块的参数"><a href="#在界面模块中实现调整算法模块的参数" aria-hidden="true" class="header-anchor">#</a> 在界面模块中实现调整算法模块的参数</h2> <h4 id="_1-在qt-designer中创建widget的ui文件并添加到工程中"><a href="#_1-在qt-designer中创建widget的ui文件并添加到工程中" aria-hidden="true" class="header-anchor">#</a> 1. 在QT Designer中创建Widget的UI文件并添加到工程中</h4> <p><img src="https://coding.net/api/project/2904101/files/4618608/imagePreview" alt="图片"></p> <p><img src="https://coding.net/api/project/2904101/files/4618622/imagePreview" alt="图片"></p> <div class="language-c extra-class"><pre class="language-c"><code>WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">WidgetDemo</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">QWidget</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ui<span class="token punctuation">.</span><span class="token function">setupUi</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-获得算法模块moduledemo类的对象指针"><a href="#_2-获得算法模块moduledemo类的对象指针" aria-hidden="true" class="header-anchor">#</a> 2. 获得算法模块<code>ModuleDemo</code>类的对象指针</h4> <div class="language-c extra-class"><pre class="language-c"><code>bool WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setMdlPtr</span><span class="token punctuation">(</span>AbstractModule <span class="token operator">*</span> m<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	mdl_ <span class="token operator">=</span> dynamic_cast<span class="token operator">&lt;</span>ModuleDemo <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mdl_ <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> true<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> false<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们就能调用算法模块的函数了。本例中，<code>WidgetDemo</code>已经被声明成了<code>ModuleDemo</code>的友元类，因此可以直接对其私有成员变量赋值。</p> <h4 id="_3-获得显示窗口的指针"><a href="#_3-获得显示窗口的指针" aria-hidden="true" class="header-anchor">#</a> 3. 获得显示窗口的指针</h4> <div class="language-c extra-class"><pre class="language-c"><code>bool WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">initDisplay</span><span class="token punctuation">(</span>GtDisplay <span class="token operator">*</span> display<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	display_ <span class="token operator">=</span> display<span class="token punctuation">;</span>
	<span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们就可以向显示窗口中添加Qt的<code>GraphicsItem</code>类了。</p> <h4 id="_4-初始化参数配置界面"><a href="#_4-初始化参数配置界面" aria-hidden="true" class="header-anchor">#</a> 4. 初始化参数配置界面</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">initParamUi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//将滑动条的位置设置为初始化的阈值</span>
	ui<span class="token punctuation">.</span>binaryThreshold<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>mdl_<span class="token operator">-&gt;</span>binary_threshold_ <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//在显示窗口中添加可拖动矩形框</span>
	display_<span class="token operator">-&gt;</span><span class="token function">addRectItem</span><span class="token punctuation">(</span><span class="token string">&quot;roi&quot;</span><span class="token punctuation">,</span> <span class="token function">QRectF</span><span class="token punctuation">(</span><span class="token function">QPointF</span><span class="token punctuation">(</span>mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>x<span class="token punctuation">,</span> mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">QSizeF</span><span class="token punctuation">(</span>mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>width<span class="token punctuation">,</span> mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//新建一个覆盖在roi上的图层，并将它添加到显示窗口中</span>
	roi_overlay_ <span class="token operator">=</span> new QGraphicsPixmapItem<span class="token punctuation">;</span>
	display_<span class="token operator">-&gt;</span><span class="token function">addUserDefinedItem</span><span class="token punctuation">(</span>roi_overlay_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化信号槽</span>
	<span class="token function">initConnects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该函数会在参数配置界面打开时被调用。<code>GtDisplay</code>提供了很多向显示窗口添加对象的接口，包括现在我们所使用的<code>addRectItem()</code>和<code>addUserDefinedItem()</code>。前者是预先定义好的可拖动item，在添加的同时，需要设置它的名字，位置和大小；后者接受一个<code>QGraphicsItem</code>指针，将其放入显示窗口的<code>QGraphicsScene</code>中。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">initConnects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">connect</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>binaryThreshold<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">valueChanged</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">connect</span><span class="token punctuation">(</span>display_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GtDisplay<span class="token punctuation">:</span><span class="token punctuation">:</span>signalUpdateDefaultItem<span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span>slotUpdateItemData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>GtDisplay</code>的<code>signalUpdateDefaultItem</code>信号会在点击可拖动窗口释放后发出，并传递出若干参数，包括窗口的位置，大小以及旋转角度。</p> <h4 id="_5-槽函数"><a href="#_5-槽函数" aria-hidden="true" class="header-anchor">#</a> 5. 槽函数</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	mdl_<span class="token operator">-&gt;</span>binary_threshold_ <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>binaryThreshold<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
	<span class="token function">updateROI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">slotUpdateItemData</span><span class="token punctuation">(</span>bool valid<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve0<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve1<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve2<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve3<span class="token punctuation">,</span> <span class="token keyword">double</span> reserve4<span class="token punctuation">,</span> QString <span class="token operator">&amp;</span> name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">&quot;roi&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>x <span class="token operator">=</span> reserve0<span class="token punctuation">;</span>
			mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>y <span class="token operator">=</span> reserve1<span class="token punctuation">;</span>
			mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>width <span class="token operator">=</span> reserve2<span class="token punctuation">;</span>
			mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>height <span class="token operator">=</span> reserve3<span class="token punctuation">;</span>
			<span class="token function">updateROI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当信号发出后，槽函数被调用，这样我们就可以根据信号来调整算法模块中的参数了。</p> <h4 id="_6-更新函数"><a href="#_6-更新函数" aria-hidden="true" class="header-anchor">#</a> 6. 更新函数</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">updateROI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//调用算法模块的二值化函数</span>
	mdl_<span class="token operator">-&gt;</span><span class="token function">doBinary</span><span class="token punctuation">(</span>mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">,</span> mdl_<span class="token operator">-&gt;</span>refer_mat_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获得二值化后的roi区域图像</span>
	Mat binary <span class="token operator">=</span> mdl_<span class="token operator">-&gt;</span>binary_mat_<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将二值化图像从Mat格式转化成Qt的格式</span>
	QPixmap pixmap <span class="token operator">=</span> QPixmap<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fromImage</span><span class="token punctuation">(</span><span class="token function">QImage</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uchar<span class="token operator">*</span><span class="token punctuation">)</span>binary<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
		binary<span class="token punctuation">.</span>cols<span class="token punctuation">,</span>
		binary<span class="token punctuation">.</span>rows<span class="token punctuation">,</span>
		binary<span class="token punctuation">.</span>cols<span class="token punctuation">,</span>
		QImage<span class="token punctuation">:</span><span class="token punctuation">:</span>Format_Indexed8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将二值化图像添加到覆盖图层上</span>
	roi_overlay_<span class="token operator">-&gt;</span><span class="token function">setPixmap</span><span class="token punctuation">(</span>pixmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将覆盖图层位置设置为roi的位置</span>
	roi_overlay_<span class="token operator">-&gt;</span><span class="token function">setPos</span><span class="token punctuation">(</span>mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>x<span class="token punctuation">,</span> mdl_<span class="token operator">-&gt;</span>roi_rect_<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//更新覆盖图层</span>
	roi_overlay_<span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更新函数调用了算法模块的二值化函数，并将结果覆盖在了roi区域。每个槽函数在最后都会调用更新函数，所以每当参数改变时，我们能立即看到二值化的效果。</p> <h4 id="_7-当基准图像被改变时"><a href="#_7-当基准图像被改变时" aria-hidden="true" class="header-anchor">#</a> 7. 当基准图像被改变时</h4> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> WidgetDemo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">doAfterReferImageChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">updateROI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个函数会在设置新的基准图像后被调用，一般我们会在其中写入清理之前显示结果的实现。</p> <h2 id="注册算法类和界面类"><a href="#注册算法类和界面类" aria-hidden="true" class="header-anchor">#</a> 注册算法类和界面类</h2> <p>本平台的特点之一就是可以根据类名去动态加载DLL。为了做到这一点，我们要求二次开发的模块必须继承我们提供的基类。另外在算法类头文件中需要<code>#include &quot;module_plugin_register.h&quot;</code>和在界面类头文件中<code>#include &quot;widget_plugin_register.h&quot;</code>。
同时，在头文件最后使用我们提供的宏<code>REGISTER_CLASS(ModuleDemo, AbstractModule);</code>和<code>REGISTER_WIDGET(UIDemo, AbstractModuleWidget);</code>
在开发者版本的GtHawkeye软件包中，与exe可执行文件同路径下有一个名为&quot;Data&quot;的文件夹，我们需要将算法模块和界面模块编译好的DLL文件根据debug或release版本添加到&quot;Data&quot;文件夹中&quot;plugins&quot;的&quot;debug-plugin&quot;或&quot;release-plugin&quot;文件夹中。
最后，在&quot;Data&quot;文件夹中，有一个名为&quot;json&quot;的文件夹，其中&quot;tools.json&quot;文件中保存着所有DLL的类名。按照如下格式填写，平台就能识别新的DLL了。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>  
	<span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Demo&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;child_mdl&quot;</span><span class="token operator">:</span>
        <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;module_dll_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ModuleDemo&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;widget_dll_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UIDemo&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;nick_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Demo&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;chinese_description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Demo&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/module_program/module3-ui.html" class="prev">
          界面dll开发
        </a></span> <span class="next"><a href="/module_program/module_update_log.html">
          更新日志
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.e904eec8.js" defer></script><script src="/assets/js/13.c5e4b4e0.js" defer></script>
  </body>
</html>
